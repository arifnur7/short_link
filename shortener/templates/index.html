<!DOCTYPE html>
<html>
<head>
    <title>URL Shortener</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <h1>URL Shortener</h1>
    <form id="shortform" method="post">
        {% csrf_token %}
        {{ form.as_p }}
        {% if form.errors %}
            <ul>
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        {% endif %}
        <div id="errorMessage" class="error"></div>
        <button type="submit">Shorten</button>
    </form>
    <div>
        {% if url_instance %}
            <h2>Short URL</h2>
            <p>Original URL: {{ url_instance.original_url }}</p>
            <p>Short URL: <a href="{{ url_instance.short_url }}">{{ url_instance.short_url }}</a></p>
            <p>QR Code:</p>
            <img src="data:image/png;base64,{{ qr_code|safe }}">
        {% endif %}
    </div>
<script>
    document.getElementById('shortform').addEventListener('submit',function (event){
        // menghandle submit form
        event.preventDefault();

        //membersihkan pesan error sebelumnya
        const errorMessageDiv = document.getElementById('errorMessage');
        errorMessageDiv.innerHTML = '';

        //mengambil nilainya
        const originalUrl = document.querySelector('input[name="original_url"]').value;
        const shortUrl = document.querySelector('input[name="short_url"]').value;

        //validasi dasar
        if (!originalUrl){
            errorMessageDiv.innerHTML = 'Original URL is Required.';
            return;
        }

        const forbiddenWords = ['admin', 'root', 'support', 'help', 'login', 'register'];
        if (shortUrl && forbiddenWords.some(word => shortUrl.toLowerCase().includes(word))) {
            errorMessageDiv.innerHTML = 'The Short URL contain forbidden words or is reserved.';
            return;
        }

        if (shortUrl && !/^[a-zA-Z0-9]+$/.test(shortUrl)){
            errorMessageDiv.innerHTML = 'Custome URL can only contain Alfabetic and Numeric character.';
            return;
        }

        //bila validasi sudah oke, submit form
        this.submit();
    });
</script>
</body>
</html>
